
@{
    ViewBag.Title = "Liste des usagers";
}

<h2>Liste des usagers</h2>
<hr />

<div class="prevent-select">
    <div class="main">
        <table id="AccountsContainer">
            <!-- Refreshed periodically -->
        </table>
    </div>
</div>

@section Scripts {

    <script defer>
        let onBlockChanged = (child) => {
            if (child == undefined)
                return;

            // State
            let checked = child.prop("checked");
            let name = child.prop("name");
            let message = checked
                ? "Voulez-vous bloquer " + name + "?"
                : "Voulez-vous débloquer " + name +"?";

            bootbox.confirm(message,
                function (result) {

                    if (!result) {
                        child.prop("checked", !checked);
                        return;
                    }

                    $.ajax({
                        url: "@Url.Action("BlockUser", "Accounts")?id=" + child.data("id") + "&blocked=" + checked,
                        success: () => { accounts.refresh(true); },
                        error: () => { bootbox.alert("Une erreur est survenue lors de l'opération"); }
                    });
                }
            );
        };

        let onRemoveClicked = (child) => {

            let name = child.data("name");
            let message = "Voulez-vous vraiment supprimer " + name + "?";

            bootbox.confirm(message,
                function (result) {

                    if (!result)
                        return;

                    $.ajax({
                        url: "@Url.Action("DeleteUser", "Accounts")?id=" + child.data("id"),
                        success: () => { accounts.refresh(true); },
                        error: () => { bootbox.alert("Une erreur est survenue lors de l'opération"); }
                    });
                    console.log("A");
                }
            );
        };

        let onLoad = () => {
            $(".blockCB").each(function () {
                $(this).change(function () {
                    onBlockChanged($(this).children("input:checkbox:first-child"));
                });
            });

            $(".removeButton").each(function () {
                $(this).css("cursor", "pointer");
                $(this).on("click", function () {
                    onRemoveClicked($(this));
                });
            });
        };

        let accounts = new PartialRefresh("@Url.Action("Accounts")", "AccountsContainer", 15, onLoad);
    </script>
}
